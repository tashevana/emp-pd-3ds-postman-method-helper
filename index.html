<!DOCTYPE html>
<html>
<head>
  <title>3DS Method Helper</title>
</head>
<body>
  <iframe name="threeDSMethodIframe" style="display:none;"></iframe>
  
  <form id="threedsForm" method="POST" target="threeDSMethodIframe" style="display:none;">
    <input type="hidden" name="unique_id" id="unique_id" />
    <input type="hidden" name="signature" id="signature" />
  </form>

  <script>
    // Helper: parse URL query parameters
    function getQueryParams() {
      const params = {};
      window.location.search.substring(1).split("&").forEach(pair => {
        const [key, value] = pair.split("=");
        if(key) params[decodeURIComponent(key)] = decodeURIComponent(value || "");
      });
      return params;
    }

    // SHA512 function using SubtleCrypto API (returns hex)
    async function sha512(message) {
      const encoder = new TextEncoder();
      const data = encoder.encode(message);
      const hashBuffer = await crypto.subtle.digest('SHA-512', data);
      const hashArray = Array.from(new Uint8Array(hashBuffer));
      return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
    }

    async function init() {
      const params = getQueryParams();

      const {
        threeds_method_url,
        unique_id,
        amount,
        timestamp,
        merchant_password
      } = params;

      if (!threeds_method_url || !unique_id || !amount || !timestamp || !merchant_password) {
        alert("Missing required query parameters.");
        return;
      }

      const signatureString = unique_id + amount + timestamp + merchant_password;
      const signature = await sha512(signatureString);

      // Set form attributes and inputs
      const form = document.getElementById("threedsForm");
      form.action = threeds_method_url;
      document.getElementById("unique_id").value = unique_id;
      document.getElementById("signature").value = signature;

      // Submit form targeting hidden iframe
      form.submit();
      console.log("3DS Method form submitted.");
    }

    window.onload = init;
  </script>
</body>
</html>
